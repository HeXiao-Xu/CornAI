<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>æ™ºèƒ½é—®ç­”</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/chat.css}">
</head>
<body>
<div class="chat-container">
    <!-- ä¾§è¾¹æ ï¼šä¼šè¯ç®¡ç† -->
    <div class="sidebar">
        <div class="session-header">
            <h3>ä¼šè¯åˆ—è¡¨</h3>
            <button id="newSessionBtn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 4V20M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                æ–°å»ºä¼šè¯
            </button>
        </div>
        <div id="sessionList" class="session-list"></div>
        <div class="sidebar-footer">
            <div class="profile-trigger" onclick="toggleProfileModal()">
                <img class="user-avatar" src="/images/user-avatar.png">
                <span>ä¸ªäººä¿¡æ¯</span>
            </div>
        </div>

    </div>

    <!-- ä¸»èŠå¤©åŒº -->
    <div class="main-chat">
        <div id="messageHistory" class="message-history"></div>

        <!-- å›ºå®šåº•éƒ¨çš„è¾“å…¥æ¡† -->
        <div class="input-area">
            <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..."
                   onkeypress="if(event.key === 'Enter') sendMessage()">
            <button onclick="sendMessage()">å‘é€</button>
        </div>
    </div>
</div>

<!-- æ–°å»ºä¼šè¯å¼¹çª— -->
<div id="sessionModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>æ–°å»ºä¼šè¯</h3>
        <input type="text" id="sessionNameInput" placeholder="è¾“å…¥ä¼šè¯åç§°">
        <button onclick="createNewSession()">åˆ›å»º</button>
    </div>
</div>

<!-- ä¿®æ”¹åçš„ä¸ªäººä¿¡æ¯å¼¹çª— -->
<div id="profileModal" class="modal">
    <div class="profile-modal-content">
        <span class="close" onclick="closeProfileModal()">&times;</span>
        <div class="profile-header">
            <img id="profileAvatar" class="profile-avatar" src="/images/user-avatar.png">
            <div class="profile-info">
                <p id="profilePhone" class="phone-number">æ‰‹æœºå·ï¼šåŠ è½½ä¸­...</p>
            </div>
        </div>
        <div class="profile-actions">
            <button class="action-btn" onclick="handleClearHistory()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰å¯¹è¯è®°å½•</button>
            <button class="action-btn" onclick="showAgreement('user')">ğŸ“œ ç”¨æˆ·åè®®</button>
            <button class="action-btn" onclick="showAgreement('privacy')">ğŸ”’ éšç§æ”¿ç­–</button>
            <button class="action-btn" onclick="showAgreement('permissions')">ğŸ“± åº”ç”¨æƒé™</button>
            <button class="action-btn" onclick="showContact()">ğŸ“ è”ç³»æˆ‘ä»¬</button>
            <button class="action-btn" onclick="handleLogout()">ğŸšª é€€å‡ºç™»å½•</button>
            <button class="action-btn" onclick="handleDeleteAccount()">â›” æ³¨é”€è´¦æˆ·</button>
        </div>
    </div>
</div>



<script th:inline="javascript">
    let currentSessionId = null;
    let currentSessionName = null;

    document.addEventListener('DOMContentLoaded', () => {
        if (!localStorage.getItem('userId')) {
            localStorage.setItem('userId', 'user_' + Math.random().toString(36).substr(2, 9));
        }
        loadSessions();
        setupModal();
    });

    function setupModal() {
        const modal = document.getElementById("sessionModal");
        const btn = document.getElementById("newSessionBtn");
        const span = document.getElementsByClassName("close")[0];

        btn.onclick = () => {
            document.getElementById("sessionNameInput").value = "";
            modal.style.display = "flex";
            document.body.style.overflow = "hidden";
        };
        span.onclick = () => {
            modal.style.display = "none";
            document.body.style.overflow = "auto";
        };
        window.onclick = (event) => {
            if (event.target === modal) {
                modal.style.display = "none";
                document.body.style.overflow = "auto";
            }
        };
    }

    // åŠ è½½ä¼šè¯åˆ—è¡¨
    function loadSessions() {
        fetch('/api/chat/sessions', {
            headers: { 'X-User-ID': localStorage.getItem('userId') }
        })
            .then(response => {
                if (!response.ok) throw new Error('è·å–ä¼šè¯å¤±è´¥');
                return response.json();
            })
            .then(sessions => {
                const container = document.getElementById('sessionList');
                container.innerHTML = sessions.map(session => `
            <div class="session-item" data-id="${session.sessionId}">
                <div class="session-info" onclick="selectSession('${session.sessionId}', '${escapeHtml(session.name)}')">
                    <h4>${escapeHtml(session.name)}</h4>
                    <span>${new Date(session.createTime).toLocaleString()}</span>
                </div>

                <!-- æ“ä½œèœå• -->
                <div class="session-menu">
                    <button class="menu-trigger" onclick="event.stopPropagation();toggleMenu(event, '${session.sessionId}')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <circle cx="12" cy="12" r="1" transform="rotate(90 12 12)"/>
                            <circle cx="12" cy="6" r="1"/>
                            <circle cx="12" cy="18" r="1"/>
                        </svg>
                    </button>
                    <div class="menu-dropdown" id="menu-${session.sessionId}">
                        <button onclick="event.stopPropagation();renameSession('${session.sessionId}')">âœï¸ é‡å‘½å</button>
                        <button onclick="event.stopPropagation();deleteSession('${session.sessionId}')">ğŸ—‘ï¸ åˆ é™¤</button>
                    </div>
                </div>
            </div>
        `).join('');

                // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªä¼šè¯
                if (sessions.length > 0 && !currentSessionId) {
                    selectSession(sessions[0].sessionId, sessions[0].name);
                }
            })
            .catch(error => {
                console.error('åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:', error);
                alert('åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
            });
    }

    function renderSessions(sessions) {
        const container = document.getElementById('sessionList');
        container.innerHTML = sessions.map(session => `
            <div class="session-item ${currentSessionId === session.sessionId ? 'active' : ''}"
                 data-id="${session.sessionId}"
                 onclick="selectSession('${session.sessionId}', '${escapeHtml(session.name)}')">
                <h4>${escapeHtml(session.name)}</h4>
                <span>${new Date(session.createTime).toLocaleString()}</span>
            </div>
        `).join('');
    }

    function selectSession(sessionId, sessionName) {
        currentSessionId = sessionId;
        currentSessionName = sessionName;
        document.getElementById('messageHistory').innerHTML = `
            <div class="session-title">å½“å‰ä¼šè¯: ${escapeHtml(sessionName)}</div>
        `;
        loadHistory(sessionId);
        document.querySelectorAll('.session-item').forEach(item => {
            item.classList.toggle('active', item.dataset.id === sessionId);
        });
    }

    function loadHistory(sessionId) {
        fetch(`/api/chat/${sessionId}/history`, {
            headers: { 'X-User-ID': localStorage.getItem('userId') }
        })
            .then(response => response.json())
            .then(history => {
                history.forEach(msg => {
                    const [role, content] = msg.split(': ');
                    appendMessage(role, content);
                });
            })
            .catch(error => console.error('åŠ è½½å†å²æ¶ˆæ¯å¤±è´¥:', error));
    }

    function createNewSession() {
        const name = document.getElementById("sessionNameInput").value.trim();
        if (!name) {
            alert("ä¼šè¯åç§°ä¸èƒ½ä¸ºç©º");
            return;
        }

        fetch('/api/sessions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-User-ID': localStorage.getItem('userId')
            },
            body: JSON.stringify({ name })
        })
            .then(async response => {
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'åˆ›å»ºå¤±è´¥');
                }
                return response.json(); // ç¡®ä¿è¿”å›çš„æ˜¯JSON
            })
            .then(data => {
                if (!data || !data.sessionId) {
                    throw new Error("æ— æ•ˆçš„å“åº”æ ¼å¼");
                }

                document.getElementById('sessionModal').style.display = 'none';
                loadSessions(); // é‡æ–°åŠ è½½ä¼šè¯åˆ—è¡¨

                // è‡ªåŠ¨é€‰æ‹©æ–°åˆ›å»ºçš„ä¼šè¯
                selectSession(data.sessionId, name);
            })
            .catch(error => {
                console.error("åˆ›å»ºä¼šè¯å¤±è´¥:", error);
                alert(`åˆ›å»ºä¼šè¯å¤±è´¥: ${error.message.replace('Error: ', '')}`);
            });
    }



    function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        const userId = localStorage.getItem('userId');

        if (!message) {
            appendMessage('system', 'æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º');
            return;
        }
        if (!currentSessionId) {
            appendMessage('system', 'è¯·å…ˆé€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªä¼šè¯');
            return;
        }
        if (!userId) {
            appendMessage('system', 'ç”¨æˆ·æœªç™»å½•');
            return;
        }

        // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
        appendMessage('user', message);
        input.value = '';

        // æ·»åŠ æ€è€ƒçŠ¶æ€æç¤º
        const pendingMsg = appendPendingMessage();

        fetch('/api/chat/messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-User-ID': userId
            },
            body: JSON.stringify({
                sessionId: currentSessionId,
                message: message,
                stream: false
            })
        })
            .then(async response => {
                if (!response.ok) throw new Error('æœåŠ¡å™¨é”™è¯¯: ' + await response.text());
                const data = await response.json();
                if (data.error) throw new Error(data.error);

                // å…³é”®ä¿®æ”¹ï¼šç¡®ä¿å…ˆç§»é™¤ä¸´æ—¶æ¶ˆæ¯å†æ·»åŠ æ–°æ¶ˆæ¯
                if (pendingMsg && pendingMsg.remove) {
                    pendingMsg.remove();
                }
                appendMessage('assistant', data.answer);
            })
            .catch(error => {
                // æ›´æ–°æ€è€ƒçŠ¶æ€ä¸ºé”™è¯¯ä¿¡æ¯
                updatePendingMessage(pendingMsg, `å‘é€å¤±è´¥: ${error.message.replace('æœåŠ¡å™¨é”™è¯¯: ', '')}`);
            });
    }

    // æ–°å¢ï¼šæ·»åŠ æ€è€ƒä¸­çš„ä¸´æ—¶æ¶ˆæ¯
    function appendPendingMessage() {
        const historyDiv = document.getElementById('messageHistory');

        const messageDiv = document.createElement('div');
        messageDiv.className = 'message assistant pending';

        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';

        const avatar = document.createElement('div');
        avatar.className = 'avatar';

        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.innerHTML = `
        <div class="answer-section">
            <div class="answer-header">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22 11.08V12C21.9988 14.1564 21.3005 16.2547 20.0093 17.9818C18.7182 19.709 16.9033 20.9725 14.8354 21.5839C12.7674 22.1953 10.5573 22.1219 8.53447 21.3746C6.51168 20.6273 4.78465 19.2461 3.61096 17.4371C2.43727 15.628 1.87979 13.4881 2.02168 11.3363C2.16356 9.18455 2.99721 7.13631 4.39828 5.49706C5.79935 3.85781 7.69279 2.71537 9.79619 2.24013C11.8996 1.7649 14.1003 1.98232 16.07 2.86" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M22 4L12 14.01L9 11.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                æ­£åœ¨æ€è€ƒ...
            </div>
            <div class="answer-content">
                <div class="loading-dots">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            </div>
        </div>
    `;

        messageContent.append(avatar, bubble);
        messageDiv.appendChild(messageContent);
        historyDiv.appendChild(messageDiv);

        // æ»šåŠ¨åˆ°åº•éƒ¨
        historyDiv.scrollTop = historyDiv.scrollHeight;
        return messageDiv;
    }

    // æ–°å¢ï¼šæ›´æ–°ä¸´æ—¶æ¶ˆæ¯å†…å®¹
    function updatePendingMessage(element, content) {
        const bubble = element.querySelector('.bubble');
        if (!bubble) return;

        bubble.innerHTML = `
        <div class="answer-section">
            <div class="answer-header">âš ï¸ è¯·æ±‚å¼‚å¸¸</div>
            <div class="answer-content">${content}</div>
        </div>
        <div class="message-footer">
            <span class="message-time">${new Date().toLocaleTimeString()}</span>
        </div>
    `;
        element.classList.remove('pending');
    }



    function appendMessage(role, content) {
        const historyDiv = document.getElementById('messageHistory');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';

        // ä¿®æ”¹ä¸ºåˆ›å»º div å…ƒç´ æ¥æ˜¾ç¤ºå¤´åƒ
        const avatar = document.createElement('div');
        avatar.className = 'avatar';

        const bubble = document.createElement('div');
        bubble.className = 'bubble';

        if (role === 'assistant') {
            const thinkMatch = content.match(/<think>([\s\S]*?)<\/think>/);
            let thinkingContent = "";
            let answerContent = "";
            if (thinkMatch) {
                thinkingContent = thinkMatch[1];
                // æå–æ­£å¼å›ç­”å†…å®¹ï¼Œå‡è®¾ <think> æ ‡ç­¾ç»“æŸåç´§æ¥ç€å°±æ˜¯æ­£å¼å›ç­”
                answerContent = content.slice(content.indexOf('</think>') + '</think>'.length).trim();
            } else {
                // å¦‚æœæ²¡æœ‰ <think> æ ‡ç­¾ï¼Œæ•´ä¸ªå†…å®¹ä½œä¸ºå›ç­”å†…å®¹
                answerContent = content;
            }

            if (thinkingContent) {
                bubble.innerHTML += `
                <div class="thinking-section">
                    <div class="thinking-header">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 8V12M12 16H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        æ€è€ƒè¿‡ç¨‹
                    </div>
                    <div class="thinking-content">${formatContent(thinkingContent)}</div>
                </div>
            `;
            }

            if (answerContent) {
                bubble.innerHTML += `
                <div class="answer-section">
                    <div class="answer-header">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 11.08V12C21.9988 14.1564 21.3005 16.2547 20.0093 17.9818C18.7182 19.709 16.9033 20.9725 14.8354 21.5839C12.7674 22.1953 10.5573 22.1219 8.53447 21.3746C6.51168 20.6273 4.78465 19.2461 3.61096 17.4371C2.43727 15.628 1.87979 13.4881 2.02168 11.3363C2.16356 9.18455 2.99721 7.13631 4.39828 5.49706C5.79935 3.85781 7.69279 2.71537 9.79619 2.24013C11.8996 1.7649 14.1003 1.98232 16.07 2.86" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M22 4L12 14.01L9 11.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        æ­£å¼å›ç­”
                    </div>
                    <div class="answer-content">${formatContent(answerContent)}</div>
                </div>
            `;
            }

            bubble.innerHTML += `
            <div class="message-footer">
                <span class="message-time">${new Date().toLocaleTimeString()}</span>
                <div class="feedback-buttons">
                    <button class="feedback-btn like">ğŸ‘ æœ‰å¸®åŠ©</button>
                    <button class="feedback-btn dislike">ğŸ‘ éœ€æ”¹è¿›</button>
                </div>
            </div>
        `;
        } else {
            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            messageText.innerHTML = formatContent(content);
            bubble.appendChild(messageText);

            const messageFooter = document.createElement('div');
            messageFooter.className = 'message-footer';
            messageFooter.innerHTML = `
            <span class="message-time">${new Date().toLocaleTimeString()}</span>
        `;
            bubble.appendChild(messageFooter);
        }

        messageContent.appendChild(avatar);
        messageContent.appendChild(bubble);
        messageDiv.appendChild(messageContent);
        historyDiv.appendChild(messageDiv);
        historyDiv.scrollTop = historyDiv.scrollHeight;
    }


    function formatContent(content) {
        // å¤„ç†ä»£ç å—
        content = content.replace(/```(\w*)([\s\S]*?)```/g, '<pre><code>$2</code></pre>');

        // å¤„ç†æ ‡é¢˜
        content = content.replace(/### (.*?)\n/g, '<h3>$1</h3>');
        content = content.replace(/## (.*?)\n/g, '<h2>$1</h2>');
        content = content.replace(/# (.*?)\n/g, '<h1>$1</h1>');

        // å¤„ç†åˆ—è¡¨
        content = content.replace(/\n- (.*?)(\n|$)/g, '\n<li>$1</li>');
        content = content.replace(/<li>.*?<\/li>/g, function(match) {
            return match.replace(/<li>(.*?)<\/li>/, '<li>$1</li>');
        });
        content = content.replace(/(<li>.*?<\/li>)+/g, function(match) {
            return '<ul>' + match + '</ul>';
        });

        // å¤„ç†æ¢è¡Œ
        content = content.replace(/\n/g, '<br>');

        return content;
    }

    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }


    // ä¸ªäººä¿¡æ¯å¼¹çª—æ§åˆ¶
    let profileModal = document.getElementById("profileModal");

    function toggleProfileModal() {
        if (profileModal.style.display === "flex") {
            profileModal.style.display = "none";
        } else {
            loadProfileInfo();
            profileModal.style.display = "flex";
        }
    }

    function closeProfileModal() {
        profileModal.style.display = "none";
    }

    // åŠ è½½ç”¨æˆ·ä¿¡æ¯
    async function loadProfileInfo() {
        try {
            const response = await fetch('/api/account/info', {
                headers: { 'X-User-ID': localStorage.getItem('userId') }
            });
            if (!response.ok) {
                throw new Error(`è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`);
            }
            const data = await response.json();
            const encryptedPhone = encryptPhoneNumber(data.phoneNumber);
            document.getElementById('profilePhone').textContent = `æ‰‹æœºå·ï¼š${encryptedPhone}`;
        } catch (error) {
            console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            document.getElementById('profilePhone').textContent = 'æ‰‹æœºå·ï¼šåŠ è½½å¤±è´¥';
        }
    }

    // æ‰‹æœºå·åŠ å¯†å‡½æ•°
    function encryptPhoneNumber(phoneNumber) {
        return phoneNumber.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
    }

    // æ¸…ç©ºå†å²å¯¹è¯
    async function handleClearHistory() {
        if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¯¹è¯è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
        try {
            const response = await fetch(`/api/sessions/clear`, {
                method: 'DELETE',
                headers: { 'X-User-ID': localStorage.getItem('userId') }
            });
            if (!response.ok) {
                throw new Error(`æ¸…ç©ºå¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`);
            }
            alert('å·²æ¸…ç©ºæ‰€æœ‰å¯¹è¯è®°å½•');
            loadSessions();
        } catch (error) {
            alert(error.message);
        }
    }

    // æ˜¾ç¤ºåè®®å†…å®¹
    async function showAgreement(type) {
        try {
            const response = await fetch(`/api/account/agreements/${type}`);
            if (!response.ok) {
                throw new Error(`åŠ è½½åè®®å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`);
            }
            const text = await response.text();
            const title = getAgreementTitle(type);
            showModal(title, text);
        } catch (error) {
            console.error('åŠ è½½åè®®å¤±è´¥:', error);
        }
    }

    function getAgreementTitle(type) {
        const titles = {
            user: 'ç”¨æˆ·åè®®',
            privacy: 'éšç§æ”¿ç­–',
            permissions: 'åº”ç”¨æƒé™è¯´æ˜'
        };
        return titles[type] || 'åè®®å†…å®¹';
    }

    // æ˜¾ç¤ºè”ç³»æ–¹å¼
    async function showContact() {
        try {
            const response = await fetch('/api/account/contact');
            if (!response.ok) {
                throw new Error(`åŠ è½½è”ç³»æ–¹å¼å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`);
            }
            const text = await response.text();
            showModal('è”ç³»æˆ‘ä»¬', text);
        } catch (error) {
            console.error('åŠ è½½è”ç³»æ–¹å¼å¤±è´¥:', error);
        }
    }

    // åˆ›å»ºå¹¶æ˜¾ç¤ºæ¨¡æ€æ¡†çš„é€šç”¨å‡½æ•°
    function showModal(title, content) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px">
            <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
            <h3>${title}</h3>
            <div class="agreement-content">${content}</div>
        </div>
    `;
        document.body.appendChild(modal);
        modal.style.display = 'block';
    }

    // é€€å‡ºç™»å½•
    function handleLogout() {
        if (!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) return;
        localStorage.removeItem('userId');
        window.location.href = '/login';
    }

    // æ³¨é”€è´¦æˆ·
    async function handleDeleteAccount() {
        if (!confirm('ç¡®å®šè¦æ°¸ä¹…æ³¨é”€è´¦æˆ·å—ï¼Ÿæ‰€æœ‰æ•°æ®å°†è¢«åˆ é™¤ä¸”ä¸å¯æ¢å¤ï¼')) return;
        try {
            const response = await fetch(`/api/account`, {
                method: 'DELETE',
                headers: { 'X-User-ID': localStorage.getItem('userId') }
            });
            if (!response.ok) {
                throw new Error(`æ³¨é”€å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`);
            }
            localStorage.removeItem('userId');
            alert('è´¦æˆ·å·²æˆåŠŸæ³¨é”€');
            window.location.href = '/login';
        } catch (error) {
            alert(error.message);
        }
    }

    // åˆå§‹åŒ–åŠ è½½ç”¨æˆ·ä¿¡æ¯
    document.addEventListener('DOMContentLoaded', loadProfileInfo);

    //=======================================================================================
    // æ§åˆ¶èœå•æ˜¾ç¤º/éšè—
    let currentOpenMenu = null;

    function toggleMenu(event, sessionId) {
        event.stopPropagation();
        const menu = document.getElementById(`menu-${sessionId}`);

        if (currentOpenMenu && currentOpenMenu !== menu) {
            currentOpenMenu.style.display = 'none';
        }

        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        currentOpenMenu = menu.style.display === 'block' ? menu : null;
    }

    // ç‚¹å‡»é¡µé¢å…¶ä»–ä½ç½®å…³é—­èœå•
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.menu-dropdown') && !e.target.closest('.menu-trigger')) {
            document.querySelectorAll('.menu-dropdown').forEach(menu => {
                menu.style.display = 'none';
            });
            currentOpenMenu = null;
        }
    });

    // é‡å‘½åä¼šè¯
    function renameSession(sessionId) {
        const sessionItem = document.querySelector(`.session-item[data-id="${sessionId}"]`);
        const currentName = sessionItem.querySelector('h4').textContent;

        const newName = prompt('è¯·è¾“å…¥æ–°çš„ä¼šè¯åç§°ï¼š', currentName);
        if (newName && newName.trim() !== currentName) {
            fetch(`/api/sessions/${sessionId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-User-ID': localStorage.getItem('userId')
                },
                body: JSON.stringify({ newName })
            })
                .then(response => {
                    if (response.ok) {
                        sessionItem.querySelector('h4').textContent = newName;
                        if (currentSessionId === sessionId) {
                            currentSessionName = newName;
                            document.querySelector('.session-title').textContent = `å½“å‰ä¼šè¯: ${newName}`;
                        }
                    } else {
                        throw new Error('é‡å‘½åå¤±è´¥');
                    }
                })
                .catch(error => {
                    alert(error.message);
                });
        }
    }

    // åˆ é™¤ä¼šè¯
    async function deleteSession(sessionId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥å¯¹è¯è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
        try {
            const response = await fetch(`/api/sessions/${sessionId}`, {
                method: 'DELETE',
                headers: { 'X-User-ID': localStorage.getItem('userId') }
            });

            if (response.status === 204) {
                // åˆ é™¤æˆåŠŸï¼Œæ›´æ–°UI
                document.querySelector(`.session-item[data-id="${sessionId}"]`).remove();
                if (currentSessionId === sessionId) {
                    currentSessionId = null;
                    document.getElementById('messageHistory').innerHTML = '';
                }
            } else {
                const error = await response.text();
                alert(`åˆ é™¤å¤±è´¥: ${error}`);
            }
        } catch (error) {
            alert('ç½‘ç»œé”™è¯¯: ' + error.message);
        }
    }

</script>
</body>
</html>